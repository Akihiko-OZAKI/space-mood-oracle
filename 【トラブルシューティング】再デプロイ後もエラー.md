# トラブルシューティング: 再デプロイ後もエラー

## 🔍 状況

- Renderで `DATABASE_URL` を `/test` に変更
- Manual Deployを実行
- 公開UIを再読み込み
- しかし、まだエラーが発生

---

## 🔍 確認手順

### ステップ1: Renderのログを確認（最重要）

1. Renderダッシュボード → `space-mood-oracle` サービス → **Logs** タブ
2. 最新のログを確認
3. 以下のメッセージを探してください：

**確認すべきログ:**

```
[Database] Initializing MySQL pool with TLS to mysql://gateway01.ap-northeast-1.prod.aws.tidbcloud.com:4000/test
```

**データベース名が `/test` になっているか確認**

**次に、接続成功のメッセージを確認:**
```
[Database] Connection object created successfully.
```

**エラーメッセージがないか確認:**
- `[Database] Failed to connect`
- `DrizzleQueryError`
- `getaddrinfo ENOTFOUND`
- `Table doesn't exist`

---

### ステップ2: 環境変数が正しく設定されているか確認

1. Renderダッシュボード → `space-mood-oracle` サービス → **Environment** タブ
2. `DATABASE_URL` の値を確認
3. データベース名が `/test` になっているか確認

---

### ステップ3: デプロイが完了しているか確認

1. Renderダッシュボード → `space-mood-oracle` サービス → **Events** タブ
2. 最新のデプロイのステータスを確認
3. "Live" になっているか確認
4. デプロイがまだ進行中の場合は、完了を待つ

---

## 🔧 考えられる原因と解決方法

### 原因1: 環境変数の変更が反映されていない

**症状:**
- ログに `/space_mood_oracle` が表示される
- データベース接続は成功しているが、テーブルが見つからない

**解決方法:**
1. Environmentタブで `DATABASE_URL` を再度確認
2. 値が `/test` になっているか確認
3. 正しく設定されている場合、**Manual Deploy** を再実行

---

### 原因2: デプロイが完了していない

**症状:**
- Eventsタブでデプロイが "Building" や "Deploying" になっている

**解決方法:**
- デプロイが完了するまで待つ（通常1〜3分）

---

### 原因3: データベース接続エラー

**症状:**
- ログに `[Database] Failed to connect` が表示される

**解決方法:**
1. `DATABASE_URL` の値を再確認
2. パスワードが正しいか確認
3. ホスト名が正しいか確認

---

### 原因4: テーブルが存在しない

**症状:**
- データベース接続は成功しているが、クエリが失敗
- ログに `Table doesn't exist` が表示される

**解決方法:**
1. TiDB CloudのSQL Editorで確認：
   ```sql
   USE test;
   SHOW TABLES;
   ```
2. 以下のテーブルが存在するか確認：
   - `daily_sentiment_scores`
   - `predictions`
   - `space_weather_data`
   - `users`
3. 存在しない場合は、テーブルを作成

---

### 原因5: データが存在しない（これはエラーではない）

**症状:**
- データベース接続は成功
- テーブルは存在する
- しかし、データが表示されない

**解決方法:**
- これは正常な状態です
- `/lab` ページから「実データ取得（NOAA）」を実行してデータを投入

---

## 📋 チェックリスト

確認してください：

- [ ] **Renderのログを確認**
  - `[Database] Initializing MySQL pool with TLS to mysql://...:4000/test` が表示されているか
  - データベース名が `/test` になっているか
  - `[Database] Connection object created successfully.` が表示されているか
  - エラーメッセージがないか

- [ ] **Environmentタブで確認**
  - `DATABASE_URL` が `/test` になっているか

- [ ] **Eventsタブで確認**
  - 最新のデプロイが "Live" になっているか

- [ ] **TiDB Cloudで確認**
  - `test` データベースにテーブルが存在するか

---

**まず、RenderのLogsタブを開いて、最新のログを確認してください。特に `[Database] Initializing MySQL pool with TLS to` の行を見て、データベース名が `/test` になっているか確認してください！** 🔍

