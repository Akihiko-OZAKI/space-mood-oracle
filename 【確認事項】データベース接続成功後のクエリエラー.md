# 確認事項: データベース接続成功後のクエリエラー

## ✅ 確認済み

- Renderのログに `[Database] Connection object created successfully.` が表示されている
- データベース接続は成功している
- Vercelの再デプロイは不要（データベースはRenderからのみ接続）

---

## 🔍 次の確認事項

データベース接続は成功していますが、クエリエラーが発生している可能性があります。

### ステップ1: Renderのログでクエリエラーを確認

Renderのログをスクロールして、以下のようなエラーメッセージを探してください：

**探すべきキーワード:**
- `DrizzleQueryError`
- `Failed query`
- `Table doesn't exist`
- `Error:`

**特に、APIリクエストが来たときのログを確認：**
- フロントエンドからAPIリクエストが来たとき（例: `/api/trpc/oracle.getTodayFortune`）
- そのリクエスト処理中に発生したエラー

---

### ステップ2: ブラウザのコンソールエラーを確認

公開UI（https://space-mood-oracle.vercel.app）を開いて、開発者ツール（F12）のコンソールを確認：

**確認すべきエラー:**
- `TRPCClientError: Failed query`
- どのテーブルへのクエリが失敗しているか
- エラーメッセージの詳細

---

### ステップ3: TiDB Cloudでテーブルの存在を確認

データベース接続は成功していますが、`test` データベースにテーブルが存在するか確認：

1. TiDB Cloudコンソール → SQL Editor
2. 以下のSQLを実行：
   ```sql
   USE test;
   SHOW TABLES;
   ```

**確認すべきテーブル:**
- `daily_sentiment_scores`
- `predictions`
- `space_weather_data`
- `users`

---

## 🔧 考えられる原因

### 原因1: テーブルが存在しない

**症状:**
- データベース接続は成功
- クエリが失敗
- エラーメッセージに `Table doesn't exist` が含まれる

**解決方法:**
- TiDB Cloudでテーブルを作成

---

### 原因2: データが存在しない

**症状:**
- データベース接続は成功
- テーブルは存在する
- クエリは成功するが、結果が空

**これはエラーではない:**
- 正常な状態です
- `/lab` ページから「実データ取得（NOAA）」を実行してデータを投入

---

### 原因3: クエリのパラメータが間違っている

**症状:**
- データベース接続は成功
- テーブルは存在する
- しかし、クエリが失敗

**解決方法:**
- エラーメッセージの詳細を確認
- コードのクエリ部分を確認

---

## 📋 次のアクション

1. **Renderのログでクエリエラーを探す**
   - `DrizzleQueryError` や `Failed query` がないか確認
   - フロントエンドからAPIリクエストが来たときのログを確認

2. **TiDB Cloudでテーブルの存在を確認**
   - `USE test; SHOW TABLES;` を実行
   - 必要なテーブルが存在するか確認

3. **ブラウザのコンソールエラーを確認**
   - どのクエリが失敗しているか確認
   - エラーメッセージの詳細を確認

---

**まず、Renderのログをスクロールして、`DrizzleQueryError` や `Failed query` というエラーメッセージがないか確認してください。特に、APIリクエストが来たとき（フロントエンドからアクセスしたとき）のログを見てください！** 🔍

