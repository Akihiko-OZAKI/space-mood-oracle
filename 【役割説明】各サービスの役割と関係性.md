# 各サービスの役割と関係性

## 📊 全体像

```
┌──────────┐      ┌──────────┐      ┌──────────┐
│  GitHub  │─────▶│  Render  │─────▶│ TiDB Cloud│
│ (コード) │      │ (バックエンド) │      │ (データベース) │
└────┬─────┘      └────┬─────┘      └──────────┘
     │                 │
     │                 │ APIリクエスト
     │                 │ (https://space-mood-oracle.onrender.com)
     │                 │
     │                 ▼
     │           ┌──────────┐
     └──────────▶│  Vercel  │
                 │ (フロントエンド) │
                 │ (https://space-mood-oracle.vercel.app)
                 └──────────┘
```

---

## 🎯 各サービスの役割

### 1. GitHub（コード管理・リポジトリホスティング）

**役割:**
- **ソースコードの保存とバージョン管理**
- **Gitリポジトリのホスティング**
- **コードの変更履歴を管理**

**使用目的:**
- プロジェクトのソースコードをGitで管理
- コードの変更をコミット・プッシュ
- チーム開発時のコード共有

**今回のプロジェクトでの使用:**
- `space-mood-oracle` リポジトリにコードを保存
- RenderとVercelがGitHubから自動的にコードを取得してデプロイ
- コードを変更してプッシュすると、自動的にデプロイが開始される

**URL例:**
- リポジトリ: `https://github.com/Akihiko-OZAKI/space-mood-oracle`

---

### 2. Render（バックエンドAPIサーバーのホスティング）

**役割:**
- **Node.jsサーバーの実行環境を提供**
- **バックエンドAPI（tRPC）をホスティング**
- **データベースとの通信を処理**

**使用目的:**
- Express + tRPC で構築されたAPIサーバーを実行
- フロントエンドからのAPIリクエストを受け取り、データベースにアクセス
- データを取得・保存・処理してフロントエンドに返す

**今回のプロジェクトでの使用:**
- `server/` ディレクトリのコードを実行
- 以下のAPIエンドポイントを提供:
  - `/api/trpc/oracle.getTodayFortune` - 今日の宇宙の意思を取得
  - `/api/trpc/sentiment.getDailyScores` - 感情スコアを取得
  - `/api/trpc/spaceWeather.getData` - 宇宙天気データを取得
  - など

**URL:**
- 本番環境: `https://space-mood-oracle.onrender.com`
- APIエンドポイント: `https://space-mood-oracle.onrender.com/api/trpc/...`

**環境変数:**
- `DATABASE_URL` - TiDB Cloudへの接続文字列
- `CORS_ORIGIN` - 許可するフロントエンドのURL（VercelのURL）
- `JWT_SECRET` - 認証用のシークレット
- `NODE_ENV` - 実行環境（production）
- `PORT` - サーバーのポート番号（10000）

**デプロイの流れ:**
1. GitHubにコードをプッシュ
2. RenderがGitHubからコードを取得
3. `npm install` で依存関係をインストール
4. `npm run build` でビルド
5. `npm start` でサーバーを起動

---

### 3. Vercel（フロントエンドのホスティング）

**役割:**
- **React/Viteで構築されたフロントエンドをホスティング**
- **静的サイトの配信**
- **CDNによる高速配信**

**使用目的:**
- `client/` ディレクトリのコードをビルドして配信
- ユーザーがブラウザでアクセスするWebページを提供
- フロントエンドからRenderのAPIサーバーにリクエストを送信

**今回のプロジェクトでの使用:**
- 公開UI: `https://space-mood-oracle.vercel.app/`
- メンテUI: `https://space-mood-oracle.vercel.app/lab`
- ブラウザで表示されるページを提供

**環境変数:**
- `VITE_API_BASE_URL` - RenderのAPIサーバーのURL（`https://space-mood-oracle.onrender.com`）

**デプロイの流れ:**
1. GitHubにコードをプッシュ
2. VercelがGitHubからコードを取得
3. `npm install` で依存関係をインストール
4. `npm run build` でフロントエンドをビルド（Vite）
5. ビルド結果（`dist/public`）をCDNに配信

**ルーティング:**
- `/` - 公開UI（`Public.tsx`）
- `/lab` - メンテUI（`Home.tsx`）
- `vercel.json` で `/lab` ルートを設定

---

### 4. TiDB Cloud（データベース）

**役割:**
- **MySQL互換のクラウドデータベースサービス**
- **データの永続化**
- **データの保存・取得・更新・削除**

**使用目的:**
- アプリケーションのデータを保存
- 以下のテーブルを管理:
  - `daily_sentiment_scores` - 日別の感情スコア
  - `space_weather_data` - 宇宙天気データ
  - `predictions` - 推論結果
  - `users` - ユーザー情報

**今回のプロジェクトでの使用:**
- `test` データベースを使用
- Renderのバックエンドサーバーが接続
- Drizzle ORMを使ってデータベースにアクセス

**接続方法:**
- MySQL接続文字列（`DATABASE_URL`）を使用
- TLS/SSL接続必須
- ホスト: `gateway01.ap-northeast-1.prod.aws.tidbcloud.com`
- ポート: `4000`
- データベース名: `test`

**データの流れ:**
1. RenderのAPIサーバーがTiDB Cloudに接続
2. クエリを実行してデータを取得・保存
3. 結果をフロントエンドに返す

---

## 🔄 データの流れ

### ユーザーが公開UIにアクセスした場合

1. **ユーザー** → `https://space-mood-oracle.vercel.app/` にアクセス
2. **Vercel** → HTML/JavaScript/CSSを配信
3. **ブラウザ** → ページを表示
4. **ブラウザ** → `https://space-mood-oracle.onrender.com/api/trpc/oracle.getTodayFortune` にAPIリクエスト
5. **Render** → リクエストを受信
6. **Render** → TiDB Cloudに接続してデータを取得
7. **TiDB Cloud** → データを返す
8. **Render** → データをフロントエンドに返す（JSON）
9. **ブラウザ** → データを表示

---

## 📦 コードの配置

### GitHubリポジトリの構造

```
space-mood-oracle/
├── client/              # フロントエンド（Vercelでデプロイ）
│   ├── src/
│   │   ├── pages/
│   │   │   ├── Public.tsx    # 公開UI
│   │   │   └── Home.tsx      # メンテUI
│   │   └── main.tsx
│   └── index.html
├── server/              # バックエンド（Renderでデプロイ）
│   ├── _core/
│   │   └── index.ts    # Expressサーバー
│   ├── routers.ts      # tRPCルーター
│   └── db.ts           # データベース接続
├── drizzle/            # データベーススキーマ
│   ├── schema.ts
│   └── *.sql           # マイグレーションファイル
├── vercel.json         # Vercel設定
└── package.json        # 依存関係
```

---

## 🔐 認証・セキュリティ

### CORS（Cross-Origin Resource Sharing）

- **Vercel（フロントエンド）** → **Render（バックエンド）** へのリクエスト
- Renderの `CORS_ORIGIN` 環境変数で、VercelのURLを許可
- 異なるドメイン間での通信を可能にする

### データベース接続

- TiDB Cloudへの接続はTLS/SSL必須
- `DATABASE_URL` に認証情報（ユーザー名・パスワード）を含む
- Renderの環境変数で管理（機密情報として保護）

---

## 🎯 まとめ

| サービス | 役割 | 担当する部分 |
|---------|------|------------|
| **GitHub** | コード管理 | ソースコードの保存・バージョン管理 |
| **Render** | バックエンド | APIサーバー、データベースとの通信 |
| **Vercel** | フロントエンド | Webページの配信、ユーザーインターフェース |
| **TiDB Cloud** | データベース | データの永続化、保存・取得 |

---

**この構成により、コード管理、バックエンド、フロントエンド、データベースがそれぞれ別々のサービスで管理され、スケーラブルで保守しやすいアーキテクチャになっています！** 🚀

