# エラー対応: データベースクエリ失敗の解決方法

## 🔴 現在のエラー状況

公開UIにアクセスはできているが、以下のエラーが発生：

1. **「データ取得エラー」** が表示される
2. データベースクエリが失敗している：
   - `predictions` テーブルへのクエリが失敗
   - `daily_sentiment_scores` テーブルへのクエリが失敗
   - `space_weather_data` テーブルへのクエリが失敗
3. Render APIサーバーが500エラーを返している

## 🔍 原因の可能性

### 1. データベース接続の問題（最も可能性が高い）

Render側の `DATABASE_URL` 環境変数が正しく設定されていない、または接続できない。

**確認方法:**
1. Renderダッシュボード → `space-mood-oracle` サービス → **Environment** タブ
2. `DATABASE_URL` が設定されているか確認
3. 値が正しいか確認（TiDB Cloudの接続文字列）

### 2. テーブルが存在しない

データベースにテーブルが作成されていない。

**確認方法:**
- TiDB Cloudのコンソールで、テーブルが存在するか確認

### 3. データが存在しない

テーブルは存在するが、データが入っていない（これはエラーではなく「データがありません」と表示されるべき）。

### 4. タイムゾーンの問題

日付の比較でタイムゾーンの違いによりクエリが失敗している可能性。

## 🛠️ 解決手順

### ステップ1: Renderのログを確認

1. Renderダッシュボード → `space-mood-oracle` サービス → **Logs** タブ
2. 最新のログを確認
3. エラーメッセージを探す：
   - `DrizzleQueryError`
   - `getaddrinfo ENOTFOUND`
   - `Database connection failed`
   - `Table doesn't exist`

**確認すべきエラーメッセージの例:**
```
[DrizzleQueryError] Failed query: select ... from `predictions` ...
cause: Error: getaddrinfo ENOTFOUND gateway01.ap-northeast-1.prod.aws.tidbcloud.com
```

または

```
[DrizzleQueryError] Failed query: select ... from `predictions` ...
cause: Error: Table 'test.predictions' doesn't exist
```

### ステップ2: DATABASE_URL環境変数を確認

1. Renderダッシュボード → `space-mood-oracle` サービス → **Environment** タブ
2. `DATABASE_URL` の値を確認
3. 正しい形式か確認：
   ```
   mysql://USERNAME:PASSWORD@HOST:4000/DATABASE_NAME?ssl-mode=REQUIRED
   ```

**TiDB Cloudの接続文字列の例:**
```
mysql://LgmGciWwK5YKo7Q.root:PASSWORD@gateway01.ap-northeast-1.prod.aws.tidbcloud.com:4000/space_mood_oracle?ssl-mode=REQUIRED
```

**注意:**
- ホスト名に `.`（ドット）が含まれていることを確認（`gateway01.ap-northeast-1.prod.aws.tidbcloud.com`）
- ポート番号は `4000`
- データベース名は `space_mood_oracle` または `test`

### ステップ3: データベース接続をテスト

Renderのログで、以下のようなメッセージを確認：

**正常な場合:**
```
[Database] Initializing MySQL pool with TLS to mysql://gateway01.ap-northeast-1.prod.aws.tidbcloud.com:4000/space_mood_oracle
[Database] Connection object created successfully.
```

**異常な場合:**
```
[Database] DATABASE_URL is not set. Cannot create connection.
```
または
```
[Database] Failed to connect: Error: getaddrinfo ENOTFOUND ...
```

### ステップ4: テーブルの存在確認（TiDB Cloud）

1. TiDB Cloudコンソールにログイン
2. データベースを選択
3. 以下のテーブルが存在するか確認：
   - `predictions`
   - `daily_sentiment_scores`
   - `space_weather_data`

**テーブルが存在しない場合:**
- Drizzleマイグレーションを実行する必要がある
- または、SQLスクリプトでテーブルを作成

### ステップ5: 修正後の再デプロイ

修正後は、Renderで **Manual Deploy** を実行する必要がある場合があります。

---

## 🔧 よくある問題と解決方法

### 問題1: `getaddrinfo ENOTFOUND` エラー

**原因:** データベースのホスト名が解決できない

**解決方法:**
1. `DATABASE_URL` のホスト名を確認
2. ホスト名に `.` が含まれているか確認
3. タイポがないか確認

**正しい例:**
```
gateway01.ap-northeast-1.prod.aws.tidbcloud.com
```

**間違いの例:**
```
gateway01ap-northeast-1.prod.aws.tidbcloud.com  ← ドットが抜けている
```

### 問題2: `Table doesn't exist` エラー

**原因:** テーブルが作成されていない

**解決方法:**
1. Drizzleマイグレーションを実行
2. または、手動でSQLスクリプトを実行

### 問題3: `Access denied` エラー

**原因:** データベースの認証情報が間違っている

**解決方法:**
1. TiDB Cloudのパスワードを確認
2. `DATABASE_URL` のパスワード部分を確認
3. URLエンコードが必要な場合がある（特殊文字が含まれる場合）

### 問題4: `Connections using insecure transport are prohibited` エラー

**原因:** TLS接続が必要だが、設定されていない

**解決方法:**
- `server/db.ts` でTLS設定が正しく行われているか確認
- `ssl-mode=REQUIRED` が `DATABASE_URL` に含まれているか確認

---

## 📋 チェックリスト

問題を解決するために、以下を確認してください：

- [ ] **Renderのログを確認**
  - エラーメッセージを特定
  - `DrizzleQueryError` の詳細を確認

- [ ] **DATABASE_URL環境変数を確認**
  - Renderダッシュボード → Environment タブ
  - 値が正しく設定されているか確認

- [ ] **データベース接続を確認**
  - ログで `[Database] Connection object created successfully.` が表示されているか確認

- [ ] **テーブルの存在を確認**
  - TiDB Cloudコンソールでテーブルが存在するか確認

- [ ] **修正後の再デプロイ**
  - 必要に応じて Manual Deploy を実行

---

## 🎯 次のステップ

1. **Renderのログを確認**して、具体的なエラーメッセージを特定
2. エラーメッセージに基づいて、上記の解決手順を実行
3. 修正後、公開UIが正常に動作するか確認

---

**まずは、Renderのログを確認して、具体的なエラーメッセージを教えてください！** 🔍

