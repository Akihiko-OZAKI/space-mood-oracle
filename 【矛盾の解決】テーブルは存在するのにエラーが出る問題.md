# 矛盾の解決: テーブルは存在するのにエラーが出る問題

## 🔍 状況

- ✅ **TiDB Cloud**: `test` データベースに8つのテーブルが存在（`space_weather_data` を含む）
- ❌ **Renderのログ**: `Tables in current database: []` （テーブルが0個）

これは矛盾しています。

---

## 🤔 考えられる原因

### 1. データベース接続の不一致

Renderが接続しているデータベースと、TiDB Cloudで確認したデータベースが**別のクラスタやリージョン**の可能性があります。

**確認方法:**
- Renderの `DATABASE_URL` 環境変数を確認
- TiDB Cloudで、接続文字列が指しているクラスタを確認

---

### 2. ユーザー権限の問題

Renderの接続ユーザーが、`test` データベースのテーブルを**見る権限**を持っていない可能性があります。

**確認方法:**
- TiDB Cloudで、接続ユーザーの権限を確認
- `GRANT SELECT ON test.* TO 'ユーザー名'@'%';` を実行

---

### 3. データベース名の不一致

`SELECT DATABASE()` で `test` と表示されていても、実際には別のデータベースに接続している可能性があります。

**確認方法:**
- Renderのログで、`DATABASE_URL` のパス部分を確認
- TiDB Cloudで、接続文字列が指しているデータベース名を確認

---

## 🔧 解決方法

### 方法1: 接続文字列を再確認

1. **Renderダッシュボード** → `space-mood-oracle` サービス → **Environmentタブ**
2. **`DATABASE_URL` 環境変数**を確認
3. 接続文字列の形式：
   ```
   mysql://ユーザー名:パスワード@ホスト:ポート/データベース名
   ```
4. **データベース名部分**が `/test` になっているか確認

---

### 方法2: TiDB Cloudで接続文字列を再生成

1. **TiDB Cloudダッシュボード** → クラスタを選択
2. **Connect** ボタンをクリック
3. **Connect your app** を選択
4. **Connection String** をコピー
5. データベース名部分を `/test` に変更
6. Renderの `DATABASE_URL` 環境変数を更新
7. **再デプロイ**

---

### 方法3: 権限を確認・付与

TiDB CloudのSQL Editorで、以下を実行：

```sql
USE test;

-- 現在のユーザーを確認
SELECT USER(), CURRENT_USER();

-- テーブル一覧を確認（権限がある場合）
SHOW TABLES;

-- もし権限がない場合、管理者に権限を付与してもらう
-- （TiDB Cloudの無料プランでは、通常は自動的に権限が付与されている）
```

---

## 🎯 次のステップ

1. **Renderの `DATABASE_URL` 環境変数を確認**
   - データベース名部分が `/test` になっているか
   - ホスト名が正しいか

2. **TiDB Cloudで接続文字列を再生成**
   - 最新の接続文字列を取得
   - データベース名を `/test` に変更

3. **再度「実データ取得」を実行**
   - Vercelの `/lab` から実行
   - RenderのLogsタブで、最新のログを確認

---

## 📊 確認すべきポイント

- [ ] Renderの `DATABASE_URL` が `/test` を指しているか
- [ ] TiDB Cloudの接続文字列と一致しているか
- [ ] ホスト名が正しいか（`gateway01.ap-northeast-1.prod.aws.tidbcloud.com`）
- [ ] ユーザー名とパスワードが正しいか

---

**まず、Renderの `DATABASE_URL` 環境変数を確認してください！** 🔍
